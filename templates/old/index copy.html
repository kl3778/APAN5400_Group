<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Merch Launch Predictor</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body class="bg-gray-50 font-sans">

<header class="bg-white shadow-sm border-b border-gray-200 py-6 mb-6">
  <div class="max-w-5xl mx-auto px-6">
    <h1 class="text-3xl font-bold text-gray-800 tracking-tight">Pop Flow Demo</h1>
    <p class="text-gray-500 text-lg mt-1">
      Big-Data-powered timing & category predictions for artist merchandise
    </p>
  </div>
</header>

<div class="max-w-5xl mx-auto px-6 mb-4">
  <label for="artistSelect" class="block text-gray-700 font-semibold mb-2">Select Artist:</label>
  <select id="artistSelect" class="border border-gray-300 rounded px-3 py-2">
    <option value="{{ singers[0] }}" selected>{{ singers[0] }}</option>
    {% for singer in singers[1:] %}
      <option value="{{ singer }}">{{ singer }}</option>
    {% endfor %}
  </select>
</div>

<main class="max-w-5xl mx-auto px-6 space-y-6">
  <!-- Artist Info & Recommendation -->
  <div class="artist-card bg-white p-6 rounded-xl shadow flex items-center space-x-6">
    <div class="flex-1">
      <div id="artistName" class="artist-name text-xl font-semibold text-gray-800">Loading...</div>
      <div id="recommendationScore" class="mt-2 text-gray-700 font-medium">
        Recommendation Score: <span id="scoreValue" class="text-purple-600 font-bold">N/A</span>
      </div>
      <div class="artist-index mt-4">
        <canvas id="artistIndexGraph" height="100"></canvas>
      </div>
    </div>
  </div>

  <!-- Song Popularity Bar Chart -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Song Popularity</h2>
    <canvas id="songBarChart" height="120"></canvas>
  </div>

  <!-- US Geo Map -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">US Top Songs by State</h2>
    <div id="usMap" style="height: 450px;"></div>
  </div>
</main>

<script>
let chartLine = null;
let chartBar = null;

// -----------------------------
// Render line chart
function renderLineChart(data) {
  const ctx = document.getElementById('artistIndexGraph').getContext('2d');
  if (chartLine) chartLine.destroy();

  chartLine = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.playback_dates,
      datasets: [{
        label: 'Daily Playback',
        data: data.playback_counts,
        borderColor: 'rgb(128, 90, 250)',
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: { responsive: true }
  });
}

// -----------------------------
// Render bar chart
function renderBarChart(data) {
  const ctx = document.getElementById('songBarChart').getContext('2d');
  if (chartBar) chartBar.destroy();

  chartBar = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.song_names,
      datasets: [{
        label: "Popularity",
        data: data.popularities,
        backgroundColor: "rgba(128,90,250,0.7)"
      }]
    },
    options: { responsive: true }
  });
}

// -----------------------------
// Render US Map
function renderUSMap(data) {
  const dom = document.getElementById('usMap');
  const prev = echarts.getInstanceByDom(dom);
  if (prev) prev.dispose();

  const map = echarts.init(dom);

  // Format data
  const formatted = data.map(row => ({
    name: row.name,
    value: row.value,
    top_song: row.top_song
  }));

  const uniqueSongs = [...new Set(formatted.map(d => d.top_song))].filter(s => s && s !== "N/A");
  const songToId = new Map(uniqueSongs.map((s, i) => [s, i+1]));

  formatted.forEach(d => {
    d.value = d.top_song !== "N/A" ? songToId.get(d.top_song) : 0;
  });

  map.setOption({
    tooltip: {
      trigger: 'item',
      formatter: params => {
        return `${params.data?.name || "N/A"}<br>Top Song: ${params.data?.top_song || "N/A"}`;
      }
    },
    visualMap: {
      min: 1,
      max: uniqueSongs.length,
      type: 'continuous',
      orient: 'vertical',
      left: 'right',
      top: 'middle',
      inRange: {
        color: ['#e3f2fd','#bbdefb','#90caf9','#64b5f6','#42a5f5','#2196f3']
      }
    },
    series: [{
      type: 'map',
      map: 'USA',
      roam: true,
      label: { show: true },
      data: formatted
    }]
  });
}

// -----------------------------
// -----------------------------
// Recommendation Score
async function renderRecommendationScore(singerName) {
  try {
    const res = await fetch(`/api/recommendation?singer_name=${encodeURIComponent(singerName)}`);
    
    if (!res.ok) {
      console.warn("Recommendation API returned non-ok status:", res.status);
      document.getElementById('scoreValue').textContent = "N/A";
      return;
    }

    const data = await res.json();
    console.log("Recommendation API response:", data); // Debug log

    const scoreEl = document.getElementById('scoreValue');

    if (data && data.score !== undefined && data.score !== null) {
      scoreEl.textContent = data.score;

      if (data.score >= 80) scoreEl.className = "text-green-600 font-bold";
      else if (data.score >= 50) scoreEl.className = "text-yellow-600 font-bold";
      else scoreEl.className = "text-red-600 font-bold";

    } else {
      // If API returned empty or missing score
      console.warn("Recommendation score missing for singer:", singerName);
      scoreEl.textContent = "N/A";
      scoreEl.className = "text-gray-600 font-bold";
    }

  } catch (e) {
    console.error("Failed to fetch recommendation score:", e);
    document.getElementById('scoreValue').textContent = "N/A";
    document.getElementById('scoreValue').className = "text-gray-600 font-bold";
  }
}


// -----------------------------
// Load artist data
async function loadArtist(singerName) {
  try {
    // Playback
    const resPlayback = await fetch(`/api/playbacks?singer_name=${encodeURIComponent(singerName)}`);
    if (resPlayback.ok) {
      const dataPlayback = await resPlayback.json();
      document.getElementById('artistName').textContent = dataPlayback.singer_name;
      renderLineChart(dataPlayback);
    }

    // Song popularity
    const resSongs = await fetch(`/api/songs?singer_name=${encodeURIComponent(singerName)}`);
    if (resSongs.ok) {
      const dataSongs = await resSongs.json();
      renderBarChart(dataSongs);
    }

    // US Map
    const resStates = await fetch(`/api/state-map?singer_name=${encodeURIComponent(singerName)}`);
    if (resStates.ok) {
      const dataStates = await resStates.json();
      renderUSMap(dataStates);
    }

    // Recommendation
    await renderRecommendationScore(singerName);

  } catch(e) {
    console.error(e);
  }
}

// -----------------------------
// DOMContentLoaded
document.addEventListener("DOMContentLoaded", () => {
  const artistSelect = document.getElementById("artistSelect");

  fetch('/static/usa-states.json')
    .then(res => res.json())
    .then(json => {
      echarts.registerMap('USA', json);
      loadArtist(artistSelect.value);

      artistSelect.addEventListener("change", () => loadArtist(artistSelect.value));
    })
    .catch(err => console.error("Failed to load USA GeoJSON:", err));
});
</script>

</body>
</html>
