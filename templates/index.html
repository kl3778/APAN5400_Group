<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pop Flow Demo</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-50 font-sans">

<header class="bg-white shadow-sm border-b border-gray-200 py-6 mb-6">
  <div class="max-w-5xl mx-auto px-6">
    <h1 class="text-3xl font-bold text-gray-800 tracking-tight">PopFlow Demo</h1>
    <p class="text-gray-500 text-lg mt-1">Unlocking Culture Momentum for Smarter IP Commercialization</p>
  </div>
</header>

<!-- Artist dropdown -->
<div class="max-w-5xl mx-auto px-6 mb-4">
  <label for="artistSelect" class="block text-gray-700 font-semibold mb-2">Select Artist:</label>
  <select id="artistSelect" class="border border-gray-300 rounded px-3 py-2">
  {% for artist in artists %}
    <option value="{{ artist.artist_id }}">{{ artist.artist_name }}</option>
  {% endfor %}
</select>
</div>

<main class="max-w-5xl mx-auto px-6 space-y-6">

  <!-- Artist Name + Recommendation Score + Line Chart -->
  <div class="artist-card bg-white p-6 rounded-xl shadow space-y-4">
    <div id="artistName" class="text-xl font-semibold text-gray-800">Loading...</div>

  <div id="recommendationScore" class="text-gray-700 font-medium flex items-center space-x-4">
    <span>Recommendation Score:</span>
    <span id="scoreValue" class="font-bold text-purple-600 text-6xl">N/A</span>
  </div>

    <canvas id="dailyChart" height="100"></canvas>
  </div>

  <!-- Song Popularity Bar Chart -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Track Popularity</h2>
    <canvas id="songChart" height="120"></canvas>
  </div>
</main>

<script>
let lineChart = null;
let barChart = null;

// -----------------------------
// Render daily streams line chart
function renderLineChart(data) {
  const ctx = document.getElementById("dailyChart").getContext("2d");
  if (lineChart) lineChart.destroy();

  lineChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: data.dates,
      datasets: [{
        label: "Daily Streams",
        data: data.streams,
        borderColor: "rgb(128, 90, 250)",
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: { responsive: true }
  });
}

// -----------------------------
// Render track popularity bar chart
function renderBarChart(data) {
  const ctx = document.getElementById("songChart").getContext("2d");
  if (barChart) barChart.destroy();

  barChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: data.track_names,
      datasets: [{
        label: "Popularity",
        data: data.track_popularities,
        backgroundColor: "rgba(128,90,250,0.7)"
      }]
    },
    options: { responsive: true }
  });
}

// -----------------------------
// Recommendation Score
async function renderRecommendation(artist_id) {
  try {
    const res = await fetch(`/api/recommendation?artist_id=${artist_id}`);
    const data = await res.json();

    const score = data.score ?? "N/A";
    const scoreEl = document.getElementById("scoreValue");
    scoreEl.textContent = score;

    if (score === "N/A") {
      scoreEl.className = "font-bold text-gray-400";
    } else if (score >= 70) {
      scoreEl.className = "font-bold text-green-600";
    } else if (score >= 40) {
      scoreEl.className = "font-bold text-yellow-600";
    } else {
      scoreEl.className = "font-bold text-red-600";
    }
  } catch(e) {
    console.error("Failed to load recommendation:", e);
  }
}

// -----------------------------
// Load all artist data
async function loadArtist(artist_id) {

  // Daily streams
  try {
    const resDaily = await fetch(`/api/playbacks?artist_id=${artist_id}`);
    if (resDaily.ok) {
      const data = await resDaily.json();
      document.getElementById("artistName").textContent = data.artist_name;
      renderLineChart({dates: data.dates, streams: data.streams});
    }
  } catch(e) { console.error(e); }

  // Song popularity
  try {
    const resSongs = await fetch(`/api/songs?artist_id=${artist_id}`);
    if (resSongs.ok) {
      const data = await resSongs.json();
      renderBarChart({track_names: data.track_names, track_popularities: data.track_popularities});
    }
  } catch(e) { console.error(e); }

  // Recommendation Score
  renderRecommendation(artist_id);
}

// -----------------------------
// Init
document.addEventListener("DOMContentLoaded", () => {
  const select = document.getElementById("artistSelect");
  if(select.value) loadArtist(select.value);

  select.addEventListener("change", () => {
    loadArtist(select.value);
  });
});
</script>

</body>
</html>
